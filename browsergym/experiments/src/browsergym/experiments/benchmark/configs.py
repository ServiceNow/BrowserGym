import numpy as np
from browsergym.experiments.benchmark.metadata.utils import (
    task_list_from_metadata,
    task_metadata,
)
from browsergym.experiments.benchmark.utils import (
    make_env_args_list_from_fixed_seeds,
    make_env_args_list_from_repeat_tasks,
    make_env_args_list_from_workarena_curriculum,
)

from .base import Benchmark, HighLevelActionSetArgs

# These are mean as the default highlevel action set to fairly evaluate agents on each benchmark.
# They are mostly arbitrary, the important thing is to evaluate different agents using the same action set for fairness.
DEFAULT_HIGHLEVEL_ACTION_SET_ARGS = {
    "miniwob_all": HighLevelActionSetArgs(
        subsets=["miniwob_all"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "miniwob_liu18": HighLevelActionSetArgs(
        subsets=["miniwob_liu18"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "miniwob_shi17": HighLevelActionSetArgs(
        subsets=["miniwob_shi17"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "miniwob_humphreys22": HighLevelActionSetArgs(
        subsets=["miniwob_humphreys22"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "workarena": HighLevelActionSetArgs(
        subsets=["workarena"],  # no need for infeasible action
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "workarena++": HighLevelActionSetArgs(
        subsets=["workarena++"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    # from https://arxiv.org/abs/2307.13854
    "webarena": HighLevelActionSetArgs(
        subsets=["webarena"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    # from https://arxiv.org/abs/2401.13649
    "visualwebarena": HighLevelActionSetArgs(
        subsets=["visualwebarena"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "assistantbench": HighLevelActionSetArgs(
        subsets=["assistantbench"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
    "weblinx": HighLevelActionSetArgs(
        subsets=["weblinx"],
        multiaction=False,
        strict=False,
        retry_with_force=True,
        demo_mode="off",
    ),
}

# all benchmarks are callables designed for lazy loading, i.e. `bench = DEFAULT_BENCHMARKS["miniwob_all"]()`
DEFAULT_BENCHMARKS = {
    "miniwob": lambda n_repeats=5: Benchmark(
        name="miniwob",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["miniwob_all"],
        is_multi_tab=False,
        supports_parallel_seeds=True,
        backends=["miniwob"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=task_list_from_metadata(metadata=task_metadata("miniwob")),
            max_steps=10,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("miniwob"),
    ),
    "miniwob_tiny_test": lambda n_repeats=2: Benchmark(
        name="miniwob_tiny_test",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["miniwob_all"],
        is_multi_tab=False,
        supports_parallel_seeds=True,
        backends=["miniwob"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=["miniwob.click-dialog", "miniwob.click-checkboxes"],
            max_steps=5,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("miniwob"),
    ),
    "webarena": lambda n_repeats=1: Benchmark(
        name="webarena",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["webarena"],
        is_multi_tab=True,
        supports_parallel_seeds=False,
        backends=["webarena"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=task_list_from_metadata(metadata=task_metadata("webarena")),
            max_steps=30,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("webarena"),
    ),
    "webarena_lite": lambda n_repeats=1: Benchmark(
        name="webarena_lite",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["webarena"],
        is_multi_tab=True,
        supports_parallel_seeds=False,
        backends=["webarena"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=[
                    "webarenalite.4",
                    "webarenalite.7",
                    "webarenalite.15",
                    "webarenalite.20",
                    "webarenalite.23",
                    "webarenalite.27",
                    "webarenalite.33",
                    "webarenalite.37",
                    "webarenalite.43",
                    "webarenalite.44",
                    "webarenalite.48",
                    "webarenalite.56",
                    "webarenalite.58",
                    "webarenalite.65",
                    "webarenalite.69",
                    "webarenalite.71",
                    "webarenalite.75",
                    "webarenalite.77",
                    "webarenalite.82",
                    "webarenalite.88",
                    "webarenalite.93",
                    "webarenalite.95",
                    "webarenalite.96",
                    "webarenalite.97",
                    "webarenalite.98",
                    "webarenalite.103",
                    "webarenalite.109",
                    "webarenalite.115",
                    "webarenalite.117",
                    "webarenalite.118",
                    "webarenalite.123",
                    "webarenalite.125",
                    "webarenalite.127",
                    "webarenalite.131",
                    "webarenalite.135",
                    "webarenalite.139",
                    "webarenalite.144",
                    "webarenalite.149",
                    "webarenalite.155",
                    "webarenalite.156",
                    "webarenalite.157",
                    "webarenalite.162",
                    "webarenalite.167",
                    "webarenalite.169",
                    "webarenalite.173",
                    "webarenalite.182",
                    "webarenalite.190",
                    "webarenalite.196",
                    "webarenalite.202",
                    "webarenalite.205",
                    "webarenalite.211",
                    "webarenalite.215",
                    "webarenalite.220",
                    "webarenalite.221",
                    "webarenalite.225",
                    "webarenalite.227",
                    "webarenalite.235",
                    "webarenalite.236",
                    "webarenalite.240",
                    "webarenalite.247",
                    "webarenalite.250",
                    "webarenalite.254",
                    "webarenalite.258",
                    "webarenalite.259",
                    "webarenalite.268",
                    "webarenalite.270",
                    "webarenalite.276",
                    "webarenalite.283",
                    "webarenalite.285",
                    "webarenalite.287",
                    "webarenalite.288",
                    "webarenalite.296",
                    "webarenalite.300",
                    "webarenalite.311",
                    "webarenalite.313",
                    "webarenalite.318",
                    "webarenalite.321",
                    "webarenalite.324",
                    "webarenalite.333",
                    "webarenalite.335",
                    "webarenalite.348",
                    "webarenalite.349",
                    "webarenalite.354",
                    "webarenalite.357",
                    "webarenalite.361",
                    "webarenalite.367",
                    "webarenalite.368",
                    "webarenalite.369",
                    "webarenalite.374",
                    "webarenalite.376",
                    "webarenalite.381",
                    "webarenalite.382",
                    "webarenalite.383",
                    "webarenalite.384",
                    "webarenalite.386",
                    "webarenalite.387",
                    "webarenalite.392",
                    "webarenalite.401",
                    "webarenalite.404",
                    "webarenalite.415",
                    "webarenalite.419",
                    "webarenalite.423",
                    "webarenalite.426",
                    "webarenalite.431",
                    "webarenalite.440",
                    "webarenalite.448",
                    "webarenalite.454",
                    "webarenalite.458",
                    "webarenalite.464",
                    "webarenalite.466",
                    "webarenalite.470",
                    "webarenalite.476",
                    "webarenalite.485",
                    "webarenalite.488",
                    "webarenalite.491",
                    "webarenalite.497",
                    "webarenalite.505",
                    "webarenalite.506",
                    "webarenalite.509",
                    "webarenalite.514",
                    "webarenalite.516",
                    "webarenalite.521",
                    "webarenalite.524",
                    "webarenalite.528",
                    "webarenalite.534",
                    "webarenalite.538",
                    "webarenalite.548",
                    "webarenalite.566",
                    "webarenalite.567",
                    "webarenalite.574",
                    "webarenalite.577",
                    "webarenalite.582",
                    "webarenalite.599",
                    "webarenalite.601",
                    "webarenalite.605",
                    "webarenalite.612",
                    "webarenalite.619",
                    "webarenalite.626",
                    "webarenalite.631",
                    "webarenalite.641",
                    "webarenalite.645",
                    "webarenalite.652",
                    "webarenalite.657",
                    "webarenalite.668",
                    "webarenalite.673",
                    "webarenalite.678",
                    "webarenalite.682",
                    "webarenalite.686",
                    "webarenalite.693",
                    "webarenalite.704",
                    "webarenalite.710",
                    "webarenalite.714",
                    "webarenalite.720",
                    "webarenalite.729",
                    "webarenalite.733",
                    "webarenalite.741",
                    "webarenalite.745",
                    "webarenalite.748",
                    "webarenalite.760",
                    "webarenalite.762",
                    "webarenalite.768",
                    "webarenalite.791",
                    "webarenalite.798",
                    "webarenalite.809",
                    "webarenalite.811",
            ],
            max_steps=30,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("webarenalite"),
    ),
    "webarena_tiny": lambda n_repeats=1: Benchmark(
        name="webarena_tiny",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["webarena"],
        is_multi_tab=True,
        supports_parallel_seeds=False,
        backends=["webarena"],
        env_args_list=make_env_args_list_from_fixed_seeds(
            task_list=[
                "webarena.410",
                "webarena.533",
                "webarena.537",
                "webarena.552",
                "webarena.561",
                "webarena.562",
            ],
            max_steps=30,
            fixed_seeds=[0],
        ),
        task_metadata=task_metadata("webarena"),
    ),
    "visualwebarena_tiny": lambda n_repeats=10: Benchmark(
        name="visualwebarena_tiny",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["visualwebarena"],
        is_multi_tab=True,
        supports_parallel_seeds=False,
        backends=["visualwebarena"],
        env_args_list=make_env_args_list_from_fixed_seeds(
            task_list=[
                "visualwebarena.228",
                "visualwebarena.263",
                "visualwebarena.550",
                "visualwebarena.784",
            ],
            max_steps=30,
            fixed_seeds=[0],
        ),
        task_metadata=task_metadata("visualwebarena"),
    ),
    "visualwebarena": lambda n_repeats=1: Benchmark(
        name="visualwebarena",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["visualwebarena"],
        is_multi_tab=True,
        supports_parallel_seeds=False,
        backends=["visualwebarena"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=task_list_from_metadata(metadata=task_metadata("visualwebarena")),
            max_steps=30,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("visualwebarena"),
    ),
    "workarena_l1": lambda n_repeats=10: Benchmark(
        name="workarena_l1",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["workarena"],
        is_multi_tab=False,
        supports_parallel_seeds=True,
        backends=["workarena"],
        env_args_list=make_env_args_list_from_workarena_curriculum(
            level="l1",
            task_category_filter=None,
            meta_seed=42,  # meta seed for evaluation curriculum
            max_steps=15,
            curriculum_type="agent",
            seeds_l1=n_repeats,
        ),
        task_metadata=task_metadata("workarena"),
    ),
    "workarena_l2_agent_curriculum_eval": lambda n_repeats=1: Benchmark(
        name="workarena_l2_agent_curriculum_eval",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["workarena++"],
        is_multi_tab=True,
        supports_parallel_seeds=True,
        backends=["workarena"],
        env_args_list=make_env_args_list_from_workarena_curriculum(
            level="l2",
            task_category_filter=None,
            meta_seed=42,  # meta seed for evaluation curriculum
            max_steps=50,
            curriculum_type="agent",
        ),
        task_metadata=task_metadata("workarena"),
    ),
    "workarena_l3_agent_curriculum_eval": lambda n_repeats=1: Benchmark(
        name="workarena_l3_agent_curriculum_eval",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["workarena++"],
        is_multi_tab=True,
        supports_parallel_seeds=True,
        backends=["workarena"],
        env_args_list=make_env_args_list_from_workarena_curriculum(
            level="l3",
            task_category_filter=None,
            meta_seed=42,  # meta seed for evaluation curriculum
            max_steps=50,
            curriculum_type="agent",
        ),
        task_metadata=task_metadata("workarena"),
    ),
    "assistantbench": lambda n_repeats=1: Benchmark(
        name="assistantbench",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["assistantbench"],
        is_multi_tab=True,
        supports_parallel_seeds=True,
        backends=["assistantbench"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=task_list_from_metadata(
                metadata=task_metadata("assistantbench"), filter={"browsergym_split": "valid|test"}
            ),
            max_steps=30,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("assistantbench"),
    ),
    "weblinx": lambda n_repeats=1: Benchmark(
        name="weblinx",
        high_level_action_set_args=DEFAULT_HIGHLEVEL_ACTION_SET_ARGS["weblinx"],
        is_multi_tab=True,
        supports_parallel_seeds=True,
        backends=["weblinx"],
        env_args_list=make_env_args_list_from_repeat_tasks(
            task_list=task_list_from_metadata(metadata=task_metadata("weblinx")),
            max_steps=1,
            n_repeats=n_repeats,
            seeds_rng=np.random.RandomState(42),
        ),
        task_metadata=task_metadata("weblinx"),
    ),
}
