from hatchling.builders.hooks.plugin.interface import BuildHookInterface
import subprocess
import os
import pathlib

class NodeModulesBuildHook(BuildHookInterface):
    def initialize(self, version, build_data):
        package_dir = "src/browsergym/subtaskbench/package"
        absolute_package_dir = os.path.abspath(package_dir)
        
        # Run yarn install
        subprocess.run(["yarn", "install"], cwd=absolute_package_dir, check=True)
        
        # Check and fix the protoc binary
        bin_dir = os.path.join(absolute_package_dir, "node_modules", ".bin")
        protoc_path = os.path.join(bin_dir, "protoc")
        protoc_target = "../@protobuf-ts/protoc/protoc.js"
        
        if os.path.exists(protoc_path) and not os.path.islink(protoc_path):
            print("Fixing protoc binary...")
            
            # Remove the non-symlink version
            os.remove(protoc_path)
            
            # Create the symlink
            os.symlink(protoc_target, protoc_path)
            
            # Verify the symlink was created
            if os.path.islink(protoc_path):
                print(f"Successfully created symlink to {protoc_target}")
            else:
                print("Failed to create symlink")